---
layout: doc
outline: [1, 3]
lastUpdated: true
editLink: true
---

# å¼€å‘è®°å½•

## é¡¹ç›®èƒŒæ™¯

é¦–å…ˆ DPlayer çš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å®ƒçš„ä½“ç§¯ä¹Ÿå¾ˆå¤§ï¼Œå¦‚æœåªæ˜¯æƒ³è¦ä¸€ä¸ªç®€å•çš„è§†é¢‘æ’­æ”¾å™¨ï¼Œé‚£ä¹ˆ DPlayer å°±æœ‰ç‚¹å¤§æå°ç”¨äº†ã€‚

ä¸ºäº†æ›´å¥½çš„è´´åˆå½“å‰çš„éœ€æ±‚åœºæ™¯ï¼Œæˆ‘ä»¬è‡ªå·±æ‰“ç®—é‡æ„è§†é¢‘æ’­æ”¾å™¨ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€”å¾„ï¼š

1. ä»é›¶å¼€å§‹å†™ä¸€ä¸ªå…¨æ–°çš„æ’­æ”¾å™¨ (éœ€æ»¡è¶³ï¼šè½»é‡åŒ–ï¼Œæ”¯æŒ mp4 ç­‰æ ¼å¼ä»¥åŠ m3u8ï¼Œå¯ä»¥è‡ªå®šä¹‰æ’­æ”¾å™¨çš„ UI ç»“æ„ï¼Œç¬¦åˆå½“å‰ä¸šåŠ¡é€»è¾‘)
2. åˆ é™¤/æ”¹å†™å½“å‰çš„ DPlayer é€»è¾‘ ï¼ˆéœ€æ»¡è¶³ï¼šè§£è€¦è¯¥åº“ä¸­çš„è€¦åˆé€»è¾‘ï¼Œç­›é€‰å‡ºå¿…è¦çš„ä»£ç ï¼‰

### éœ€è¦æ»¡è¶³çš„ç‚¹ï¼š

å®ç°ä¸€ä¸ªç®€å•çš„ Web è§†é¢‘æ’­æ”¾å™¨ã€‚

- è§†é¢‘æ’­æ”¾å™¨ç•Œé¢è®¾è®¡å’Œå¸ƒå±€ï¼›
- è§†é¢‘åŠ è½½å’Œæ’­æ”¾æ§åˆ¶é€»è¾‘ï¼›
- å¯¹ä¸åŒæµè§ˆå™¨å’Œè®¾å¤‡çš„å…¼å®¹æ€§å¤„ç†ï¼›
- ä»£ç çš„ç»„ç»‡å’Œæ‰“åŒ…ã€‚

## å‡†å¤‡å·¥ä½œ

### é¡¹ç›®ç®¡ç†

é¡¹ç›®æ‰“ç®—é€šè¿‡ pnpm workspaces å®ç° monorepo çš„ç®¡ç†æ–¹å¼

æ‰€ä»¥å…ˆå®‰è£… pnpmï¼š

```sh
npm install -g pnpm
```

åˆå§‹åŒ–é¡¹ç›®ï¼š

```sh
mkdir tiny-player && cd tiny-player && pnpm init -y
# åˆ›å»º packages ç›®å½• ,åœ¨ packages ç›®å½•ä¸‹åˆ›å»º doc , core ç›®å½•ï¼Œç”¨äºå­˜æ”¾æ–‡æ¡£,æ’­æ”¾å™¨çš„æºç ï¼š
mkdir packages
mkdir packages/doc
mkdir packages/core
```

```yaml
# ./pnpm-workspace.yaml
packages:
  # packages/ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…
  - 'packages/*'
  # æ ¹ç›®å½•
  - '.'
  # å·¥ä½œåŒºéœ€è¦æ’é™¤çš„åŒ…ï¼Œ'!' means exclude
  # - "!**/test/**"
```

è¿›å…¥ core å®‰è£…ç›¸å…³ä¾èµ–ï¼š

```sh
npm install typescript rollup rollup-plugin-typescript2 -D
```

åˆ›å»ºä¸€ä¸ª tsconfig.json æ–‡ä»¶ï¼Œé…ç½® TypeScript ç¼–è¯‘é€‰é¡¹ï¼š

```json
{
  "compilerOptions": {
    "target": "es6",
    "module": "es6",
    "esModuleInterop": true,
    "strict": true,
    "sourceMap": true,
    "outDir": "dist"
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### æ‹“æ‰‘æ’åº

æ‹“æ‰‘æ’åºé€šå¸¸ç”¨æ¥â€œæ’åºâ€å…·æœ‰ä¾èµ–å…³ç³»çš„ä»»åŠ¡ã€‚

> æ‹“æ‰‘æ’åºï¼ˆTopological Sortingï¼‰æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆDAG, Directed Acyclic Graphï¼‰çš„æ‰€æœ‰é¡¶ç‚¹çš„çº¿æ€§åºåˆ—ã€‚ä¸”è¯¥åºåˆ—å¿…é¡»æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š
>
> - æ¯ä¸ªé¡¶ç‚¹å‡ºç°ä¸”åªå‡ºç°ä¸€æ¬¡ã€‚
> - è‹¥å­˜åœ¨ä¸€æ¡ä»é¡¶ç‚¹ A åˆ°é¡¶ç‚¹ B çš„è·¯å¾„ï¼Œé‚£ä¹ˆåœ¨åºåˆ—ä¸­é¡¶ç‚¹ A å‡ºç°åœ¨é¡¶ç‚¹ B çš„å‰é¢ã€‚

æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ‰æœ‰æ‹“æ‰‘æ’åºï¼Œé DAG å›¾æ²¡æœ‰æ‹“æ‰‘æ’åºä¸€è¯´ã€‚

![](https://assets.fedtop.com/picbed/202305231658639.png)

![](https://assets.fedtop.com/picbed/202305231658133.png)

é€šå¸¸ä¸€ä¸ªå¤æ‚çš„æœ‰å‘æ— ç¯å›¾å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ‹“æ‰‘æ’åºåºåˆ—ã€‚

## ç¼–å†™ä»£ç 

åˆ›å»ºä¸€ä¸ª src/index.ts æ–‡ä»¶ï¼Œå®ç°è§†é¢‘æ’­æ”¾å™¨çš„é€»è¾‘ï¼š

```typescript
class VideoPlayer {
  private readonly videoElement: HTMLVideoElement

  constructor(videoElementId: string) {
    this.videoElement = document.getElementById(videoElementId) as HTMLVideoElement
    this.init()
  }

  private init() {
    // åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
    this.videoElement.controls = false
    this.videoElement.addEventListener('loadedmetadata', this.onLoadedMetadata)
    this.videoElement.addEventListener('play', this.onPlay)
    this.videoElement.addEventListener('pause', this.onPause)
  }

  private onPlay = () => {
    // å½“è§†é¢‘å¼€å§‹æ’­æ”¾æ—¶ï¼Œæ›´æ–°æ’­æ”¾å™¨çŠ¶æ€
    const playPauseButton = this.videoElement.parentNode.querySelector('.play-pause') as HTMLButtonElement
    playPauseButton.innerHTML = 'Pause'
  }

  private onPause = () => {
    // å½“è§†é¢‘æš‚åœæ’­æ”¾æ—¶ï¼Œæ›´æ–°æ’­æ”¾å™¨çŠ¶æ€
    const playPauseButton = this.videoElement.parentNode.querySelector('.play-pause') as HTMLButtonElement
    playPauseButton.innerHTML = 'Play'
  }
}
```

### æ¨¡æ¿

æ¨¡æ¿å¼•æ“ï¼š

1. Ejs
1. Art-template
1. DOT
1. JavaScript-Templates
1. Template.js
1. Tempo
1. ECT
1. Dot Dom
1. Template7
1. Bunny
1. Squirrelly

> https://cloud.tencent.com/developer/article/1539238

ä½¿ç”¨ï¼š

```typescript
new TinyPlayer('my-video')
```

### MSE æ”¯æŒ

#### DASH

DASHï¼ˆDynamic Adaptive Streaming over HTTPï¼‰æ˜¯ä¸€ä¸ªè§„èŒƒäº†è‡ªé€‚åº”å†…å®¹åº”å½“å¦‚ä½•è¢«è·å–çš„åè®®ã€‚å®ƒå®é™…ä¸Šæ˜¯å»ºç«‹åœ¨ MSE é¡¶éƒ¨çš„ä¸€ä¸ªå±‚ï¼Œç”¨æ¥æ„å»ºè‡ªé€‚åº”æ¯”ç‰¹ç‡ä¸²æµå®¢æˆ·ç«¯ã€‚è™½ç„¶å·²ç»æœ‰ä¸€ä¸ªç±»ä¼¼çš„åè®®äº†ï¼ˆä¾‹å¦‚ HTTP ä¸²æµç›´æ’­ï¼ˆHLSï¼‰ï¼‰ï¼Œä½† DASH æœ‰æœ€å¥½çš„è·¨å¹³å°å…¼å®¹æ€§ã€‚

### æ€§èƒ½ç›¸å…³

æ‰€æœ‰é¢‘ç¹ä½¿ç”¨çš„æ–¹æ³•éƒ½åº”è¯¥è¢«ç¼“å­˜èµ·æ¥ï¼Œä»¥é¿å…é‡å¤è®¡ç®—ã€‚

```typescript
const { videoElement } = this
const { currentTime, duration } = videoElement
```

#### DOM æ“ä½œ

é¢‘ç¹æ›´æ¢ DOM å…ƒç´ ä¸­çš„æ–‡æœ¬æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `textContent` å±æ€§ï¼Œè€Œä¸æ˜¯ `innerHTML` å±æ€§ã€‚

```typescript
// ä¸æ¨è
playPauseButton.innerHTML = 'Pause'
// æ¨è
playPauseButton.textContent = 'Pause'
```

#### äº‹ä»¶ç›‘å¬

é¢‘ç¹æ·»åŠ å’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜ã€‚

```typescript

```

## æ‰“åŒ…ä»£ç 

åˆ›å»ºä¸€ä¸ª `rollup.config.js` æ–‡ä»¶ï¼Œé…ç½® Rollup æ‰“åŒ…é€‰é¡¹ï¼š

```javascript
import typescript from 'rollup-plugin-typescript2'

export default {
  input: 'src/index.ts',
  output: {
    file: 'dist/index.js',
    format: 'iife',
    name: 'TinyPlayer',
  },
  plugins: [typescript()],
}
```

```sh
npx rollup -c
```

ç¤ºä¾‹ï¼š

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Video Player</title>
    <style>
      .controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 50px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 5px;
        box-sizing: border-box;
        position: absolute;
        bottom: 0;
        left: 0;
      }
      .controls button,
      .controls input[type='range'] {
        margin-right: 5px;
        margin-left: 5px;
      }
      .controls button:focus,
      .controls input[type='range']:focus {
        outline: none;
      }
      .controls button:active,
      .controls input[type='range']:active {
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <video id="my-video" src="my-video.mp4"></video>
    <script src="dist/index.js"></script>
  </body>
</html>
```

## é¡¹ç›®ç»“æ„

## è§„èŒƒ

### git hooks

å®‰è£… git hooks å·¥å…·

```bash
pn add husky lint-staged -D -w
```

åˆå§‹åŒ– git hooks

```bash
#--no-install å‚æ•°è¡¨ç¤ºå¼ºåˆ¶npxä½¿ç”¨é¡¹ç›®ä¸­node_modulesç›®å½•ä¸‹çš„huskyä¾èµ–åŒ…
npx --no-install husky install
```

æ³¨å†Œç›¸åº”çš„ git hooks é’©å­

```sh
# æäº¤ä¿¡æ¯å‰æ‰§è¡Œ
npx --no-instal husky add .husky/commit-msg "<ä½ è¦æ‰§è¡Œçš„å‘½ä»¤>"
# æäº¤å‰æ‰§è¡Œ
npx --no-instal husky add .husky/pre-commit "<ä½ è¦æ‰§è¡Œçš„å‘½ä»¤>"

# è¯¥é¡¹ç›®çš„
npx --no-instal husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
npx --no-instal husky add .husky/pre-commit 'npx --no-install lint-staged'
```

è®©å…¶ä»–äººåœ¨ clone æ­¤é¡¹ç›®åå®‰è£…ä¾èµ–åè‡ªåŠ¨åˆ›å»º .husky å¹¶æ³¨å†Œ git hooks é’©å­

```sh
npm set-script prepare "husky install"
```

ä¼šåœ¨ `package.json` ä¸­æ·»åŠ å¦‚ä¸‹è„šæœ¬

```json
{
  "scripts": {
    "prepare": "husky install"
  }
}
```

### æäº¤è§„èŒƒ

å®‰è£… `commitizen` å·¥å…·

```bash
pn add commitizen commitlint-config-cz  cz-customizable @commitlint/cli @commitlint/config-conventional -D -w
```

åœ¨ `package.json` ä¸­æ·»åŠ è„šæœ¬

```sh
npm set-script commit "cz"
```

ä¼šåœ¨ `package.json` ä¸­æ·»åŠ å¦‚ä¸‹è„šæœ¬

```json
{
  "scripts": {
    "commit": "cz"
  }
}
```

åœ¨ `package.json` ä¸­æ·»åŠ é…ç½®

```json
{
  "config": {
    "commitizen": {
      "path": "node_modules/cz-customizable"
    }
  }
}
```

åˆ›å»ºä¸€ä¸ª commitlint é…ç½®æ–‡ä»¶ commitlint.config.js åˆ°é¡¹ç›®æ ¹ç›®å½• ğŸ‘‡ ä»–å°†ç»§æ‰¿@commitlint/config-conventional ä¸­çš„ Commit message è§„èŒƒã€‚ï¼ˆ"feat", "fix", "perf", "refactor"...ï¼‰

```javascript
module.exports = { extends: ['cz'] }
```

å®ç°è‡ªå®šä¹‰ commit message è§„åˆ™ï¼ˆç›´æ¥ä»è‡ªå®šä¹‰çš„æ–‡ä»¶é‡Œè¯»å–è§„åˆ™ï¼‰  
[.cz-config.js](.cz-config.js) ï¼Œ[é»˜è®¤é…ç½®.js](https://github.com/leoforfree/cz-customizable/blob/master/cz-config-EXAMPLE.js)

åœ¨ç»ˆç«¯è¿›è¡Œæµ‹è¯•

```sh
echo 'feat: bar' | npx --no-install commitlint
```

é…ç½®è¯¦æƒ…å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç«  [commitizen](https://juejin.cn/post/7063912026384367629#heading-7)

### ä»£ç è§„èŒƒ
